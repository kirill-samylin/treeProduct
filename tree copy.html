<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/tree.css">
    <!-- <link rel="stylesheet" type="text/css" href="./css/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="./css/github-dark.css" media="screen">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"> -->

    <!-- <script src="https://code.jquery.com/jquery-git1.min.js"></script>
    <script src="./js/jquery-sortable-lists.js"></script> -->
    
    <script src="./js/jquery-3.6.0.min.js"></script>
    <script src="./js/sortable.min.js"></script>
    <script src="./jquery-sortable.js"></script>
</head>
<body>
    <div id="tree-box"></div>
    <div id="form-category" class="popup">
        <form class="popup__form" method="post" action="#">
            <button class="button-close popup__button-close" type="button"></button>
            <h2 class="popup__title">Добавить</h2>
            <input class="popup__input popup__avatar" id="name" type="url" placeholder="Имя" required>
            <span class="popup__span-error" id="name-error"></span>
            <input class="popup__input popup__avatar" id="icon-url" type="url" placeholder="Ссылка на иконку" required>
            <span class="popup__span-error" id="icon-url-error">Введите адрес сайта.</span>
            <button class="popup__button-add" type="submit">Сохранить</button>
        </form>
    </div>
    <script src="./js/tree.js"></script>
    <script>
        let stor = null;
        function saveTree() {
            stor = document.getElementById("sTree2").cloneNode(true);
        }
        function start() {
            $('.sTree2').sortable({ 
                // fallbackOnBody: false,
                group: 'list',
                animation: 200,
                ghostClass: 'ghost',
                onSort: reportActivity,
                handle: '.tree__category-position',
                onStart: saveTree,
                onEnd: function (/**Event*/evt) {
                    var itemEl = evt.item;  // dragged HTMLElement
                    evt.to;    // target list
                    evt.from;  // previous list
                    evt.oldIndex;  // element's old index within old parent
                    evt.newIndex;  // element's new index within new parent
                    evt.oldDraggableIndex; // element's old index within old parent, only counting draggable elements
                    evt.newDraggableIndex; // element's new index within new parent, only counting draggable elements
                    evt.clone // the clone element
                    evt.pullMode;
                    console.log(itemEl)
                    if (evt.to.id==="sTree2" && itemEl.type==="item") {
                        alert("Ай бля");
                        const nowTree = document.getElementById("sTree2");
                        nowTree.replaceWith(stor);
                        start();
                    }
                    console.log(evt.to, evt.from)
                    console.log(evt.oldIndex, evt.newIndex)
                    console.log(stor);
                },
            });
        }
        //start();
        // Report when the sort order has changed
        function changeButton() {

        }
        function reportActivity() {
            const tree = document.getElementById("sTree2");
            //const elementTree = tree.target;
            const branches = Array.from(tree.querySelectorAll("li"));
            for (branch of branches) {
                if (branch) {
                    const list = branch.querySelector(".tree__sub-list");
                    const button = branch.querySelector(".tree__category-open");
                    if (list && button) {
                        const children = Array.from(list.querySelectorAll("li"));
                        if (children.length) {
                            button.style = "";
                        } else {
                            button.style = "opacity: .5;";
                        }
                    }
                }
            }
            console.log('The sort order has changed');
        };
    </script>
</body>
</html>